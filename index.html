<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Screener Pro</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .dropdown-enter { animation: slideDown 0.15s ease-out; }
        .stock-row:hover { background-color: rgba(59, 130, 246, 0.1); }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; }
        .tab-inactive { color: #9ca3af; }
        .tab-inactive:hover { color: #d1d5db; }
        .scrollbar-thin::-webkit-scrollbar { width: 8px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #1f2937; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        * { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        // Stock database - expanded list
        const POPULAR_STOCKS = [
            { symbol: 'RELIANCE.NS', name: 'Reliance Industries Ltd', market: 'NSE', exchange: 'India', sector: 'Oil & Gas' },
            { symbol: 'TCS.NS', name: 'Tata Consultancy Services Ltd', market: 'NSE', exchange: 'India', sector: 'IT Services' },
            { symbol: 'HDFCBANK.NS', name: 'HDFC Bank Ltd', market: 'NSE', exchange: 'India', sector: 'Banking' },
            { symbol: 'INFY.NS', name: 'Infosys Ltd', market: 'NSE', exchange: 'India', sector: 'IT Services' },
            { symbol: 'HINDUNILVR.NS', name: 'Hindustan Unilever Ltd', market: 'NSE', exchange: 'India', sector: 'FMCG' },
            { symbol: 'ICICIBANK.NS', name: 'ICICI Bank Ltd', market: 'NSE', exchange: 'India', sector: 'Banking' },
            { symbol: 'BHARTIARTL.NS', name: 'Bharti Airtel Ltd', market: 'NSE', exchange: 'India', sector: 'Telecom' },
            { symbol: 'ITC.NS', name: 'ITC Ltd', market: 'NSE', exchange: 'India', sector: 'FMCG' },
            { symbol: 'SBIN.NS', name: 'State Bank of India', market: 'NSE', exchange: 'India', sector: 'Banking' },
            { symbol: 'LT.NS', name: 'Larsen & Toubro Ltd', market: 'NSE', exchange: 'India', sector: 'Construction' },
            { symbol: 'WIPRO.NS', name: 'Wipro Ltd', market: 'NSE', exchange: 'India', sector: 'IT Services' },
            { symbol: 'MARUTI.NS', name: 'Maruti Suzuki India Ltd', market: 'NSE', exchange: 'India', sector: 'Automobile' },
            { symbol: 'TATAMOTORS.NS', name: 'Tata Motors Ltd', market: 'NSE', exchange: 'India', sector: 'Automobile' },
            { symbol: 'TATASTEEL.NS', name: 'Tata Steel Ltd', market: 'NSE', exchange: 'India', sector: 'Metals' },
            { symbol: 'ADANIPORTS.NS', name: 'Adani Ports and SEZ Ltd', market: 'NSE', exchange: 'India', sector: 'Infrastructure' },
            { symbol: 'ASIANPAINT.NS', name: 'Asian Paints Ltd', market: 'NSE', exchange: 'India', sector: 'Paints' },
            { symbol: 'BAJFINANCE.NS', name: 'Bajaj Finance Ltd', market: 'NSE', exchange: 'India', sector: 'Finance' },
            { symbol: 'HCLTECH.NS', name: 'HCL Technologies Ltd', market: 'NSE', exchange: 'India', sector: 'IT Services' },
            { symbol: 'KOTAKBANK.NS', name: 'Kotak Mahindra Bank Ltd', market: 'NSE', exchange: 'India', sector: 'Banking' },
            { symbol: 'SUNPHARMA.NS', name: 'Sun Pharmaceutical Industries Ltd', market: 'NSE', exchange: 'India', sector: 'Pharma' },
            { symbol: 'AXISBANK.NS', name: 'Axis Bank Ltd', market: 'NSE', exchange: 'India', sector: 'Banking' },
            { symbol: 'ULTRACEMCO.NS', name: 'UltraTech Cement Ltd', market: 'NSE', exchange: 'India', sector: 'Cement' },
            { symbol: 'TITAN.NS', name: 'Titan Company Ltd', market: 'NSE', exchange: 'India', sector: 'Retail' },
            { symbol: 'NESTLEIND.NS', name: 'Nestle India Ltd', market: 'NSE', exchange: 'India', sector: 'FMCG' },
            { symbol: 'BAJAJFINSV.NS', name: 'Bajaj Finserv Ltd', market: 'NSE', exchange: 'India', sector: 'Finance' },
            { symbol: 'ONGC.NS', name: 'Oil and Natural Gas Corporation Ltd', market: 'NSE', exchange: 'India', sector: 'Oil & Gas' },
            { symbol: 'NTPC.NS', name: 'NTPC Ltd', market: 'NSE', exchange: 'India', sector: 'Power' },
            { symbol: 'POWERGRID.NS', name: 'Power Grid Corporation of India Ltd', market: 'NSE', exchange: 'India', sector: 'Power' },
            { symbol: 'M&M.NS', name: 'Mahindra & Mahindra Ltd', market: 'NSE', exchange: 'India', sector: 'Automobile' },
            { symbol: 'TECHM.NS', name: 'Tech Mahindra Ltd', market: 'NSE', exchange: 'India', sector: 'IT Services' },
            { symbol: 'HINDALCO.NS', name: 'Hindalco Industries Ltd', market: 'NSE', exchange: 'India', sector: 'Metals' },
            { symbol: 'INDUSINDBK.NS', name: 'IndusInd Bank Ltd', market: 'NSE', exchange: 'India', sector: 'Banking' },
            { symbol: 'COALINDIA.NS', name: 'Coal India Ltd', market: 'NSE', exchange: 'India', sector: 'Mining' },
            { symbol: 'DRREDDY.NS', name: 'Dr. Reddys Laboratories Ltd', market: 'NSE', exchange: 'India', sector: 'Pharma' },
            { symbol: 'GRASIM.NS', name: 'Grasim Industries Ltd', market: 'NSE', exchange: 'India', sector: 'Cement' },
            { symbol: 'JSWSTEEL.NS', name: 'JSW Steel Ltd', market: 'NSE', exchange: 'India', sector: 'Metals' },
            { symbol: 'DIVISLAB.NS', name: 'Divis Laboratories Ltd', market: 'NSE', exchange: 'India', sector: 'Pharma' },
            { symbol: 'EICHERMOT.NS', name: 'Eicher Motors Ltd', market: 'NSE', exchange: 'India', sector: 'Automobile' },
            { symbol: 'BRITANNIA.NS', name: 'Britannia Industries Ltd', market: 'NSE', exchange: 'India', sector: 'FMCG' },
            { symbol: 'SHREECEM.NS', name: 'Shree Cement Ltd', market: 'NSE', exchange: 'India', sector: 'Cement' },
            { symbol: 'HEROMOTOCO.NS', name: 'Hero MotoCorp Ltd', market: 'NSE', exchange: 'India', sector: 'Automobile' },
            { symbol: 'CIPLA.NS', name: 'Cipla Ltd', market: 'NSE', exchange: 'India', sector: 'Pharma' },
            { symbol: 'TATACONSUM.NS', name: 'Tata Consumer Products Ltd', market: 'NSE', exchange: 'India', sector: 'FMCG' },
            { symbol: 'ADANIENT.NS', name: 'Adani Enterprises Ltd', market: 'NSE', exchange: 'India', sector: 'Conglomerate' },
            { symbol: 'APOLLOHOSP.NS', name: 'Apollo Hospitals Enterprise Ltd', market: 'NSE', exchange: 'India', sector: 'Healthcare' },
            { symbol: 'VEDL.NS', name: 'Vedanta Ltd', market: 'NSE', exchange: 'India', sector: 'Metals' },
            { symbol: 'CROMPTON.NS', name: 'Crompton Greaves Consumer Electricals Ltd', market: 'NSE', exchange: 'India', sector: 'Consumer Durables' },
            { symbol: 'HAVELLS.NS', name: 'Havells India Ltd', market: 'NSE', exchange: 'India', sector: 'Consumer Durables' },
            { symbol: 'PIDILITIND.NS', name: 'Pidilite Industries Ltd', market: 'NSE', exchange: 'India', sector: 'Chemicals' },
            { symbol: 'AAPL', name: 'Apple Inc', market: 'NASDAQ', exchange: 'USA', sector: 'Technology' },
            { symbol: 'GOOGL', name: 'Alphabet Inc', market: 'NASDAQ', exchange: 'USA', sector: 'Technology' },
            { symbol: 'MSFT', name: 'Microsoft Corporation', market: 'NASDAQ', exchange: 'USA', sector: 'Technology' },
            { symbol: 'TSLA', name: 'Tesla Inc', market: 'NASDAQ', exchange: 'USA', sector: 'Automobile' }
        ];

        // Format number in crores
        const formatCrores = (num, exchange) => {
            if (!num || num === 0) return 'N/A';
            if (exchange === 'India') {
                const crores = num / 10000000;
                if (crores >= 1000) return `‚Çπ${(crores / 1000).toFixed(2)}K Cr`;
                return `‚Çπ${crores.toFixed(2)} Cr`;
            }
            const millions = num / 1000000;
            if (millions >= 1000) return `$${(millions / 1000).toFixed(2)}B`;
            return `$${millions.toFixed(2)}M`;
        };

        // Fetch real stock data
        const fetchStockData = async (symbol) => {
            try {
                const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1d`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.chart?.result?.[0]) {
                    const result = data.chart.result[0];
                    const meta = result.meta;
                    const quote = result.indicators.quote[0];
                    
                    const currentPrice = meta.regularMarketPrice || quote.close[quote.close.length - 1];
                    const previousClose = meta.previousClose;
                    const change = currentPrice - previousClose;
                    const changePercent = (change / previousClose) * 100;
                    
                    return {
                        symbol,
                        price: currentPrice.toFixed(2),
                        change: change.toFixed(2),
                        changePercent: changePercent.toFixed(2),
                        high52w: (meta.fiftyTwoWeekHigh || currentPrice * 1.2).toFixed(2),
                        low52w: (meta.fiftyTwoWeekLow || currentPrice * 0.8).toFixed(2),
                        volume: meta.regularMarketVolume || 0,
                        marketCap: meta.marketCap || 0
                    };
                }
            } catch (error) {
                console.error('Price fetch error:', error);
            }
            return null;
        };

        // Fetch fundamentals
        const fetchFundamentals = async (symbol) => {
            try {
                const url = `https://query2.finance.yahoo.com/v10/finance/quoteSummary/${symbol}?modules=defaultKeyStatistics,financialData,summaryDetail`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.quoteSummary?.result?.[0]) {
                    const result = data.quoteSummary.result[0];
                    const keyStats = result.defaultKeyStatistics || {};
                    const financialData = result.financialData || {};
                    const summaryDetail = result.summaryDetail || {};
                    
                    return {
                        marketCap: summaryDetail.marketCap?.raw || 0,
                        pe: summaryDetail.trailingPE?.raw || keyStats.trailingPE?.raw || null,
                        pb: keyStats.priceToBook?.raw || null,
                        dividendYield: summaryDetail.dividendYield?.raw ? (summaryDetail.dividendYield.raw * 100) : null,
                        roe: financialData.returnOnEquity?.raw ? (financialData.returnOnEquity.raw * 100) : null,
                        roce: financialData.returnOnAssets?.raw ? (financialData.returnOnAssets.raw * 100) : null,
                        debtToEquity: financialData.debtToEquity?.raw ? (financialData.debtToEquity.raw / 100) : null,
                        currentRatio: financialData.currentRatio?.raw || null,
                        bookValue: keyStats.bookValue?.raw || null,
                        eps: keyStats.trailingEps?.raw || null,
                        beta: keyStats.beta?.raw || null
                    };
                }
            } catch (error) {
                console.error('Fundamentals fetch error:', error);
            }
            return null;
        };

        // Fetch historical data
        const fetchHistoricalData = async (symbol, period) => {
            try {
                const rangeMap = {'1M': '1mo', '6M': '6mo', '1Y': '1y', '3Y': '3y', '5Y': '5y', '10Y': '10y', 'MAX': 'max'};
                const range = rangeMap[period] || '1mo';
                
                const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=${range}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.chart?.result?.[0]) {
                    const result = data.chart.result[0];
                    const timestamps = result.timestamp;
                    const quotes = result.indicators.quote[0];
                    
                    return timestamps.map((timestamp, i) => ({
                        date: new Date(timestamp * 1000).toISOString().split('T')[0],
                        close: quotes.close[i],
                        price: quotes.close[i]
                    })).filter(d => d.close !== null);
                }
            } catch (error) {
                console.error('Historical data error:', error);
            }
            return [];
        };

        // Technical indicators
        const calculateSMA = (data, period) => {
            if (data.length < period) return null;
            return data.slice(-period).reduce((a, b) => a + b, 0) / period;
        };

        const calculateRSI = (prices, period = 14) => {
            if (prices.length < period + 1) return null;
            let gains = 0, losses = 0;
            for (let i = prices.length - period; i < prices.length; i++) {
                const change = prices[i] - prices[i - 1];
                if (change > 0) gains += change;
                else losses -= change;
            }
            const avgGain = gains / period;
            const avgLoss = losses / period;
            if (avgLoss === 0) return 100;
            return 100 - (100 / (1 + avgGain / avgLoss));
        };

        const calculateBollingerBands = (prices, period = 20, stdDev = 2) => {
            if (prices.length < period) return null;
            const sma = calculateSMA(prices, period);
            const squaredDiffs = prices.slice(-period).map(p => Math.pow(p - sma, 2));
            const std = Math.sqrt(squaredDiffs.reduce((a, b) => a + b, 0) / period);
            return {
                upper: sma + (stdDev * std),
                lower: sma - (stdDev * std)
            };
        };

        // Stock Search Component
        const StockSearch = ({ onSelectStock }) => {
            const [query, setQuery] = useState('');
            const [suggestions, setSuggestions] = useState([]);
            const [showDropdown, setShowDropdown] = useState(false);
            const dropdownRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (e) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(e.target)) {
                        setShowDropdown(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            const handleSearch = useCallback((value) => {
                setQuery(value);
                if (value.length < 1) {
                    setSuggestions([]);
                    setShowDropdown(false);
                    return;
                }

                const searchTerm = value.toLowerCase();
                const filtered = POPULAR_STOCKS.filter(stock => {
                    const symbolBase = stock.symbol.split('.')[0].toLowerCase();
                    return stock.symbol.toLowerCase().includes(searchTerm) ||
                           stock.name.toLowerCase().includes(searchTerm) ||
                           symbolBase.includes(searchTerm);
                }).slice(0, 8);

                setSuggestions(filtered);
                setShowDropdown(true);
            }, []);

            const handleSelect = useCallback((stock) => {
                setShowDropdown(false);
                setQuery('');
                setSuggestions([]);
                onSelectStock(stock);
            }, [onSelectStock]);

            return (
                <div className="relative" ref={dropdownRef}>
                    <input
                        type="text"
                        value={query}
                        onChange={(e) => handleSearch(e.target.value)}
                        placeholder="Search stocks..."
                        className="w-full bg-gray-700 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    
                    {showDropdown && suggestions.length > 0 && (
                        <div className="absolute z-50 w-full mt-2 bg-gray-800 border border-gray-700 rounded-lg shadow-2xl max-h-96 overflow-y-auto dropdown-enter">
                            {suggestions.map((stock, idx) => (
                                <div
                                    key={idx}
                                    onMouseDown={(e) => {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        handleSelect(stock);
                                    }}
                                    className="p-3 hover:bg-gray-700 cursor-pointer border-b border-gray-700 last:border-b-0"
                                >
                                    <div className="text-white font-semibold">{stock.name}</div>
                                    <div className="text-gray-400 text-sm">{stock.symbol} ‚Ä¢ {stock.sector}</div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // Chart Component
        const TechnicalChart = ({ symbol, timeframe, chartPeriod, enabledIndicators, rsiOnly = false }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            const [chartData, setChartData] = useState(null);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                const loadData = async () => {
                    setIsLoading(true);
                    const data = await fetchHistoricalData(symbol, timeframe);
                    
                    // Apply aggregation
                    let processedData = data;
                    if (chartPeriod === 'weekly' && data.length > 5) {
                        processedData = [];
                        for (let i = 0; i < data.length; i += 5) {
                            const week = data.slice(i, i + 5);
                            if (week.length > 0) processedData.push(week[week.length - 1]);
                        }
                    } else if (chartPeriod === 'monthly' && data.length > 20) {
                        const monthlyMap = {};
                        data.forEach(d => {
                            const month = d.date.substring(0, 7);
                            monthlyMap[month] = d;
                        });
                        processedData = Object.values(monthlyMap);
                    }
                    
                    setChartData(processedData);
                    setIsLoading(false);
                };
                
                loadData();
            }, [symbol, timeframe, chartPeriod]);

            useEffect(() => {
                if (!chartRef.current || !chartData || chartData.length === 0) {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                        chartInstance.current = null;
                    }
                    return;
                }

                const ctx = chartRef.current.getContext('2d');
                if (chartInstance.current) chartInstance.current.destroy();

                const prices = chartData.map(d => d.price || d.close);
                const labels = chartData.map(d => d.date);

                const datasets = [];
                
                if (rsiOnly) {
                    const rsiData = chartData.map((_, i) => {
                        if (i >= 14) return calculateRSI(prices.slice(0, i + 1), 14);
                        return null;
                    });
                    datasets.push({
                        label: 'RSI',
                        data: rsiData,
                        borderColor: 'rgb(251, 146, 60)',
                        backgroundColor: 'rgba(251, 146, 60, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        pointRadius: 0,
                        tension: 0.4
                    });
                } else {
                    datasets.push({
                        label: 'Price',
                        data: prices,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    });

                    if (enabledIndicators.sma50) {
                        const sma50 = chartData.map((_, i) => i >= 49 ? calculateSMA(prices.slice(0, i + 1), 50) : null);
                        datasets.push({
                            label: '50 DMA',
                            data: sma50,
                            borderColor: 'rgb(234, 179, 8)',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        });
                    }

                    if (enabledIndicators.sma200) {
                        const sma200 = chartData.map((_, i) => i >= 199 ? calculateSMA(prices.slice(0, i + 1), 200) : null);
                        datasets.push({
                            label: '200 DMA',
                            data: sma200,
                            borderColor: 'rgb(239, 68, 68)',
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0
                        });
                    }

                    if (enabledIndicators.bollinger) {
                        const upperBand = [];
                        const lowerBand = [];
                        chartData.forEach((_, i) => {
                            if (i >= 19) {
                                const bands = calculateBollingerBands(prices.slice(0, i + 1), 20, 2);
                                upperBand.push(bands.upper);
                                lowerBand.push(bands.lower);
                            } else {
                                upperBand.push(null);
                                lowerBand.push(null);
                            }
                        });
                        datasets.push({
                            label: 'BB Upper',
                            data: upperBand,
                            borderColor: 'rgba(34, 197, 94, 0.8)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        });
                        datasets.push({
                            label: 'BB Lower',
                            data: lowerBand,
                            borderColor: 'rgba(34, 197, 94, 0.8)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        });
                    }
                }

                const scales = rsiOnly ? {
                    x: { ticks: { color: 'white', maxTicksLimit: 12 }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                    y: {
                        min: 0,
                        max: 100,
                        ticks: {
                            color: 'white',
                            callback: (value) => (value === 70 || value === 30) ? value : ''
                        },
                        grid: {
                            color: (context) => (context.tick.value === 70 || context.tick.value === 30) ? 'rgba(255, 255, 255, 0.3)' : 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                } : {
                    x: { ticks: { color: 'white', maxTicksLimit: 12 }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                    y: { ticks: { color: 'white' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
                };

                chartInstance.current = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { labels: { color: 'white' } },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: 'white',
                                bodyColor: 'white'
                            }
                        },
                        scales
                    }
                });

                return () => {
                    if (chartInstance.current) chartInstance.current.destroy();
                };
            }, [chartData, enabledIndicators, rsiOnly]);

            if (isLoading) {
                return (
                    <div className="flex items-center justify-center h-full">
                        <div className="text-white text-center">
                            <div className="animate-spin h-8 w-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-2"></div>
                            <div>Loading chart...</div>
                        </div>
                    </div>
                );
            }

            if (!chartData || chartData.length === 0) {
                return (
                    <div className="flex items-center justify-center h-full">
                        <div className="text-gray-400 text-center">
                            <div className="text-4xl mb-2">üìä</div>
                            <div>No data available</div>
                        </div>
                    </div>
                );
            }

            return <canvas ref={chartRef} />;
        };

        // Main App
        const App = () => {
            const [view, setView] = useState('home');
            const [activeTab, setActiveTab] = useState('chart');
            const [watchlist, setWatchlist] = useState([]);
            const [selectedStock, setSelectedStock] = useState(null);
            const [timeframe, setTimeframe] = useState('1Y');
            const [chartPeriod, setChartPeriod] = useState('daily');
            const [enabledIndicators, setEnabledIndicators] = useState({
                sma50: true,
                sma200: true,
                bollinger: false,
                rsi: false
            });

            const tabs = [
                { id: 'chart', label: 'Chart' },
                { id: 'ratios', label: 'Ratios' }
            ];

            const timeframes = ['1M', '6M', '1Y', '3Y', '5Y', '10Y', 'MAX'];

            useEffect(() => {
                const saved = localStorage.getItem('screener_watchlist_v2');
                if (saved) {
                    setWatchlist(JSON.parse(saved));
                } else {
                    setWatchlist([
                        { symbol: 'RELIANCE.NS' },
                        { symbol: 'TCS.NS' },
                        { symbol: 'HDFCBANK.NS' }
                    ]);
                }
            }, []);

            useEffect(() => {
                if (watchlist.length > 0) {
                    localStorage.setItem('screener_watchlist_v2', JSON.stringify(watchlist));
                }
            }, [watchlist]);

            useEffect(() => {
                if (view === 'home') {
                    const updatePrices = async () => {
                        const updated = await Promise.all(
                            watchlist.map(async stock => {
                                const priceData = await fetchStockData(stock.symbol);
                                if (priceData) {
                                    return { ...stock, ...priceData };
                                }
                                return stock;
                            })
                        );
                        setWatchlist(updated);
                    };
                    updatePrices();
                }
            }, [view]);

            const viewStockDetail = useCallback(async (stock) => {
                const priceData = await fetchStockData(stock.symbol);
                if (!priceData) {
                    alert('Could not load stock data');
                    return;
                }
                
                const fundamentals = await fetchFundamentals(stock.symbol);
                
                setSelectedStock({
                    ...stock,
                    ...priceData,
                    fundamentals: fundamentals || {}
                });
                setView('detail');
                setActiveTab('chart');
            }, []);

            const addToWatchlist = useCallback(() => {
                if (!selectedStock) return;
                if (watchlist.find(s => s.symbol === selectedStock.symbol)) {
                    alert('Already in watchlist!');
                    return;
                }
                setWatchlist([...watchlist, { symbol: selectedStock.symbol }]);
            }, [selectedStock, watchlist]);

            const removeFromWatchlist = useCallback((symbol) => {
                setWatchlist(watchlist.filter(s => s.symbol !== symbol));
            }, [watchlist]);

            const toggleIndicator = useCallback((indicator) => {
                setEnabledIndicators(prev => ({
                    ...prev,
                    [indicator]: !prev[indicator]
                }));
            }, []);

            const isInWatchlist = selectedStock && watchlist.some(s => s.symbol === selectedStock.symbol);

            if (view === 'home') {
                return (
                    <div className="min-h-screen bg-gray-900">
                        <div className="bg-gray-800 border-b border-gray-700 shadow-lg">
                            <div className="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center gap-4">
                                <div>
                                    <h1 className="text-2xl font-bold text-white">Stock Screener Pro</h1>
                                    <p className="text-gray-400 text-sm">Technical & Fundamental Analysis</p>
                                </div>
                                <div className="flex-1 max-w-md">
                                    <StockSearch onSelectStock={viewStockDetail} />
                                </div>
                            </div>
                        </div>

                        <div className="max-w-7xl mx-auto px-6 py-8">
                            <div className="bg-gray-800 rounded-lg shadow-lg overflow-hidden">
                                <div className="bg-gray-700 border-b border-gray-600 px-6 py-4">
                                    <h2 className="text-xl font-bold text-white">My Watchlist ({watchlist.length})</h2>
                                </div>
                                
                                <div className="divide-y divide-gray-700">
                                    {watchlist.map((stock) => {
                                        const isPositive = parseFloat(stock.change || 0) >= 0;
                                        return (
                                            <div
                                                key={stock.symbol}
                                                className="stock-row p-6 cursor-pointer transition-colors"
                                                onClick={() => viewStockDetail(stock)}
                                            >
                                                <div className="flex justify-between items-start">
                                                    <div className="flex-1">
                                                        <div className="flex items-center gap-3 mb-2">
                                                            <h3 className="text-xl font-bold text-white">{stock.name || stock.symbol}</h3>
                                                            <span className="text-xs bg-gray-700 text-gray-300 px-3 py-1 rounded">
                                                                {stock.market || (stock.symbol.includes('.NS') ? 'NSE' : 'NASDAQ')}
                                                            </span>
                                                        </div>
                                                        
                                                        <div className="flex items-center gap-8 mt-4">
                                                            <div>
                                                                <div className="text-3xl font-bold text-white">
                                                                    {stock.price ? 
                                                                        `${stock.symbol.includes('.NS') ? '‚Çπ' : '$'}${stock.price}` 
                                                                        : '...'}
                                                                </div>
                                                                {stock.change && (
                                                                    <div className={`text-sm font-semibold ${isPositive ? 'text-green-400' : 'text-red-400'}`}>
                                                                        {isPositive ? '‚Üë' : '‚Üì'} {Math.abs(stock.change)} ({isPositive ? '+' : ''}{stock.changePercent}%)
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <button
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            removeFromWatchlist(stock.symbol);
                                                        }}
                                                        className="text-gray-500 hover:text-red-400 ml-6 text-xl"
                                                    >
                                                        ‚úï
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // Detail View
            const fund = selectedStock.fundamentals || {};
            const currency = selectedStock.exchange === 'India' ? '‚Çπ' : '$';
            const exchange = selectedStock.exchange;

            return (
                <div className="min-h-screen bg-gray-900">
                    <div className="bg-gray-800 border-b border-gray-700 shadow-lg sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-6 py-3 flex justify-between items-center gap-4">
                            <button
                                onClick={() => setView('home')}
                                className="flex items-center gap-2 text-white hover:text-blue-400 flex-shrink-0"
                            >
                                <span>‚Üê</span>
                                <span className="hidden md:inline">Watchlist</span>
                            </button>
                            
                            <div className="flex-1 max-w-md">
                                <StockSearch onSelectStock={viewStockDetail} />
                            </div>
                            
                            {!isInWatchlist && (
                                <button
                                    onClick={addToWatchlist}
                                    className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold flex-shrink-0"
                                >
                                    ‚≠ê Add
                                </button>
                            )}
                            {isInWatchlist && (
                                <div className="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold flex-shrink-0">
                                    ‚úì Added
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-6 py-6">
                        {/* Stock Header */}
                        <div className="bg-gray-800 rounded-lg p-6 mb-6 shadow-lg">
                            <div className="flex justify-between items-start mb-6">
                                <div>
                                    <h1 className="text-3xl font-bold text-white mb-2">{selectedStock.name}</h1>
                                    <div className="flex items-center gap-3">
                                        <span className="text-gray-400">{selectedStock.symbol}</span>
                                        <span className="text-sm bg-gray-700 text-gray-300 px-3 py-1 rounded">{selectedStock.market}</span>
                                        <span className="text-sm bg-blue-900 text-blue-300 px-3 py-1 rounded">{selectedStock.sector}</span>
                                    </div>
                                </div>
                                <div className="text-right">
                                    <div className="text-4xl font-bold text-white">{currency}{selectedStock.price}</div>
                                    <div className={`text-xl font-semibold ${parseFloat(selectedStock.change) >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                        {parseFloat(selectedStock.change) >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(selectedStock.change)} ({parseFloat(selectedStock.change) >= 0 ? '+' : ''}{selectedStock.changePercent}%)
                                    </div>
                                </div>
                            </div>

                            {/* Key Metrics */}
                            <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                                <div className="bg-gray-700 p-3 rounded">
                                    <div className="text-xs text-gray-400">Market Cap</div>
                                    <div className="text-lg font-bold text-white">
                                        {formatCrores(fund.marketCap || selectedStock.marketCap, exchange)}
                                    </div>
                                </div>
                                <div className="bg-gray-700 p-3 rounded">
                                    <div className="text-xs text-gray-400">P/E Ratio</div>
                                    <div className="text-lg font-bold text-white">
                                        {fund.pe ? fund.pe.toFixed(2) : 'N/A'}
                                    </div>
                                </div>
                                <div className="bg-gray-700 p-3 rounded">
                                    <div className="text-xs text-gray-400">ROE</div>
                                    <div className="text-lg font-bold text-white">
                                        {fund.roe ? fund.roe.toFixed(2) + '%' : 'N/A'}
                                    </div>
                                </div>
                                <div className="bg-gray-700 p-3 rounded">
                                    <div className="text-xs text-gray-400">ROCE</div>
                                    <div className="text-lg font-bold text-white">
                                        {fund.roce ? fund.roce.toFixed(2) + '%' : 'N/A'}
                                    </div>
                                </div>
                                <div className="bg-gray-700 p-3 rounded">
                                    <div className="text-xs text-gray-400">Div Yield</div>
                                    <div className="text-lg font-bold text-white">
                                        {fund.dividendYield ? fund.dividendYield.toFixed(2) + '%' : 'N/A'}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Tabs */}
                        <div className="bg-gray-800 rounded-lg shadow-lg mb-6">
                            <div className="flex border-b border-gray-700 overflow-x-auto">
                                {tabs.map(tab => (
                                    <button
                                        key={tab.id}
                                        onClick={() => setActiveTab(tab.id)}
                                        className={`px-6 py-4 font-semibold whitespace-nowrap ${
                                            activeTab === tab.id ? 'tab-active' : 'tab-inactive'
                                        }`}
                                    >
                                        {tab.label}
                                    </button>
                                ))}
                            </div>

                            <div className="p-6">
                                {/* Chart Tab */}
                                {activeTab === 'chart' && (
                                    <div>
                                        {/* Indicators */}
                                        <div className="bg-gray-700 rounded-lg p-4 mb-4">
                                            <h3 className="text-white font-bold mb-3">Technical Indicators</h3>
                                            <div className="flex flex-wrap gap-2">
                                                {Object.entries({
                                                    sma50: '50 DMA',
                                                    sma200: '200 DMA',
                                                    bollinger: 'Bollinger Bands',
                                                    rsi: 'RSI'
                                                }).map(([key, label]) => (
                                                    <button
                                                        key={key}
                                                        onClick={() => toggleIndicator(key)}
                                                        className={`px-3 py-2 rounded-lg text-sm font-semibold ${
                                                            enabledIndicators[key] 
                                                                ? key === 'sma50' ? 'bg-yellow-600 text-white' :
                                                                  key === 'sma200' ? 'bg-red-600 text-white' :
                                                                  key === 'bollinger' ? 'bg-green-600 text-white' :
                                                                  'bg-orange-600 text-white'
                                                                : 'bg-gray-600 text-gray-300'
                                                        }`}
                                                    >
                                                        {label}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>

                                        {/* Period */}
                                        <div className="bg-gray-700 rounded-lg p-4 mb-4">
                                            <div className="flex items-center gap-4 mb-3">
                                                <h3 className="text-white font-bold">Period:</h3>
                                                {['daily', 'weekly', 'monthly'].map(period => (
                                                    <button
                                                        key={period}
                                                        onClick={() => setChartPeriod(period)}
                                                        className={`px-4 py-2 rounded-lg font-semibold capitalize ${
                                                            chartPeriod === period ? 'bg-blue-600 text-white' : 'bg-gray-600 text-gray-300'
                                                        }`}
                                                    >
                                                        {period}
                                                    </button>
                                                ))}
                                            </div>
                                            
                                            <div className="flex flex-wrap gap-2">
                                                {timeframes.map(tf => (
                                                    <button
                                                        key={tf}
                                                        onClick={() => setTimeframe(tf)}
                                                        className={`px-4 py-2 rounded-lg font-semibold ${
                                                            timeframe === tf ? 'bg-blue-600 text-white' : 'bg-gray-600 text-gray-300'
                                                        }`}
                                                    >
                                                        {tf}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>

                                        {/* Price Chart */}
                                        <div className="bg-gray-700 rounded-lg p-4 mb-4" style={{ height: enabledIndicators.rsi ? '450px' : '550px' }}>
                                            <TechnicalChart 
                                                symbol={selectedStock.symbol}
                                                timeframe={timeframe}
                                                chartPeriod={chartPeriod}
                                                enabledIndicators={enabledIndicators}
                                            />
                                        </div>

                                        {/* RSI Pane */}
                                        {enabledIndicators.rsi && (
                                            <div className="bg-gray-700 rounded-lg p-4" style={{ height: '150px' }}>
                                                <div className="text-white text-sm font-semibold mb-2">RSI (14)</div>
                                                <TechnicalChart 
                                                    symbol={selectedStock.symbol}
                                                    timeframe={timeframe}
                                                    chartPeriod={chartPeriod}
                                                    enabledIndicators={{ rsi: true }}
                                                    rsiOnly={true}
                                                />
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* Ratios Tab */}
                                {activeTab === 'ratios' && (
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div className="bg-gray-700 p-6 rounded-lg">
                                            <h3 className="text-white font-bold mb-4">Valuation</h3>
                                            <div className="space-y-3">
                                                <div className="flex justify-between">
                                                    <span className="text-gray-400">P/E Ratio</span>
                                                    <span className="text-white font-semibold">{fund.pe ? fund.pe.toFixed(2) : 'N/A'}</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span className="text-gray-400">P/B Ratio</span>
                                                    <span className="text-white font-semibold">{fund.pb ? fund.pb.toFixed(2) : 'N/A'}</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span className="text-gray-400">Dividend Yield</span>
                                                    <span className="text-white font-semibold">{fund.dividendYield ? fund.dividendYield.toFixed(2) + '%' : 'N/A'}</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span className="text-gray-400">Book Value</span>
                                                    <span className="text-white font-semibold">{fund.bookValue ? `${currency}${fund.bookValue.toFixed(2)}` : 'N/A'}</span>
                                                </div>
                                                {fund.eps && (
                                                    <div className="flex justify-between">
                                                        <span className="text-gray-400">EPS</span>
                                                        <span className="text-white font-semibold">{fund.eps.toFixed(2)}</span>
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        <div className="bg-gray-700 p-6 rounded-lg">
                                            <h3 className="text-white font-bold mb-4">Profitability</h3>
                                            <div className="space-y-3">
                                                <div className="flex justify-between">
                                                    <span className="text-gray-400">ROE</span>
                                                    <span className="text-white font-semibold">{fund.roe ? fund.roe.toFixed(2) + '%' : 'N/A'}</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span className="text-gray-400">ROCE</span>
                                                    <span className="text-white font-semibold">{fund.roce ? fund.roce.toFixed(2) + '%' : 'N/A'}</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="bg-gray-700 p-6 rounded-lg">
                                            <h3 className="text-white font-bold mb-4">Leverage</h3>
                                            <div className="space-y-3">
                                                <div className="flex justify-between">
                                                    <span className="text-gray-400">Debt/Equity</span>
                                                    <span className="text-white font-semibold">{fund.debtToEquity ? fund.debtToEquity.toFixed(2) : 'N/A'}</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span className="text-gray-400">Current Ratio</span>
                                                    <span className="text-white font-semibold">{fund.currentRatio ? fund.currentRatio.toFixed(2) : 'N/A'}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
